<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
  <title>Movia</title>
</head>

<body>
  <%# Algorithm:
if user has not rated any movies
    display message asking user to rate some movies
else
    for each movie in the database
        initialize movieSimilarity to 0
        for each movie the user has rated
            calculate genreSimilarityScore using jacardSimilarity
            calculate castSimilarityScore using jacardSimilarity
            calculate directorSimilarityScore using jacardSimilarity
            add weighted sum of similarity scores to movieSimilarity
        add movie's rating to movieSimilarity
        add movie and movieSimilarity to recommendedMovies
    sort recommendedMovies in descending order of similarity
    filter out movies the user has already rated
    display top 10 recommendedMovies on the page
end if
   %>
  <%- include('./../templates/navbar.ejs', {loginDisplay:"block", signupDisplay:"block", }) %>
  <%
    // jacard similarity
    function jacardSimilarity(set1, set2) {
        let intersection = 0
        let union = 0
        for (let i = 0; i < set1.length; i++) {
            if (set2.includes(set1[i])) {
                intersection++
            }
        }
        union = set1.length + set2.length - intersection
        return intersection / union
    }

    function jacardSimilarity2(set1, set2) { // For testing purpose only, Found that both give almost the same result, but since the previous is standard, we will be using that only. 
        let intersection = 0
        let union = 0
        for (let i = 0; i < set1.length; i++) {
            if (set2.includes(set1[i])) {
                intersection++
            }
        }
        union = set1.length + set2.length - intersection
        return intersection / Math.max(set1.length, set2.length)
    }
   %>
  <%

  if (!myratings[user.email]) {
    %>
    <div class="alert alert-info text-center" role="alert">
      First Rate some movies.
    </div>
  <% } else { %>
  <%
    recommendedMovies = []
    for (let i = 0; i < movies.length; i++) {
        movie = movies[i]
        movieSimilarity = 0
        for (let j = 0; j < myratings[user.email].length; j++) {
            ratedMovie = myratings[user.email][j].movie

            // Calculate genre silmilarity
            genre1 = movie.genre
            genre2 = ratedMovie.genre
            genreSimilarityScore = jacardSimilarity(genre1, genre2)

            //calculate cast similarity
            cast1 = movie.Cast
            cast2 = ratedMovie.Cast
            castSimilarityScore = jacardSimilarity(cast1, cast2)

            //calculate director similarity
            director1 = movie.Director
            director2 = ratedMovie.Director
            directorSimilarityScore = jacardSimilarity(director1, director2)

            //weighted sum of similarity scores
            movieSimilarity += 0.2*(myratings[user.email][j].myrating - 5.5)*(2.5*directorSimilarityScore + 3*castSimilarityScore + 4.5* genreSimilarityScore)/10 //scaling it to 1
    }
    //add movie's rating to movieSimilarity
    movieSimilarity += movie.Rating[0]/20 
    // console.log(movie.Title, movieSimilarity)
    recommendedMovies.push({movie: movie, similarity: movieSimilarity})
    
}
recommendedMovies.sort((a, b) => b.similarity - a.similarity) //sort in descending order based on similarity

recommendedMovies = recommendedMovies.filter((movie) => {
    return !myratings[user.email].some((ratedMovie) => ratedMovie.movie.Title === movie.movie.Title) // filter out movies the user has already rated by the user
})
%>
  <div class="otherThanNav">
    <div class="container">
      <h1 class="text-center mt-3">Movies</h1>
      <div class="row">
        <div class="col-12">
          <h2 class="text-center">Recommended Movies</h2>
        </div>
        </div>
      </div>
      <div class="movie-container" style="margin: 20px;">
        <div class="row mb-3 text-center">
          <% for(let i = 0; i < 10; i++) { %>
          <%- include('./../templates/cardForRatedRecom.ejs', {movieToAdded : recommendedMovies[i].movie, i, myratings, filename:'recommend.ejs'}) %>
          <% } %>
        </div>
      </div>
    <% } %>
  
</body>

</html>