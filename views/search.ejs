<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Search results for <%= searchQuery %> </title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css">
  <link rel="stylesheet" href="/movieCards.css">
</head>

<body>
  <% function bigramize(title) {
        let bigrams = [];
        for (let i = 0; i < title.length - 1; i++) {
            bigrams.push(title.substring(i, i + 2));
        }
        return bigrams;
    } 
    
    function jaccard_similarity(bigrams1, bigrams2) {
        const set1 = new Set(bigrams1);
        const set2 = new Set(bigrams2);
        const intersection = new Set([...set1].filter(x => set2.has(x)));
        const union = new Set([...set1, ...set2]);
        return intersection.size / union.size;
    }
    
    function searchMovies(searchQuery) {
        let bigramSearchQuery = bigramize(searchQuery.toLowerCase());
    
        let similarMovies = [];
        let maxSimilarity = 0;
        let mostSimilarMovie = null;
    
        for (let i = 0; i < movies.length; i++) {
            let cleanedTitle = movies[i].Title.toLowerCase().replace(/[^a-z0-9\s]/gi, '');
            let bigramTitle = bigramize(cleanedTitle);
            let similarity = jaccard_similarity(bigramSearchQuery, bigramTitle);
    
            // Check if the search query is a substring of the movie title
            if (cleanedTitle.includes(searchQuery.toLowerCase().replace(/[\s]/g, '')) || cleanedTitle.includes(searchQuery.toLowerCase()) ) {
                similarMovies.push(movies[i]);
            } else if (similarity > 0.3) {
                similarMovies.push(movies[i]);
            }
    
            if (similarity > maxSimilarity) {
                maxSimilarity = similarity;
                mostSimilarMovie = movies[i];

            }
        }
        return similarMovies;
    }
    %>
  <%- include('./../templates/navbar.ejs', {loginDisplay:"block", signupDisplay:"block"}) %>
  <% let similarMovies = searchMovies(searchQuery); %>
  <% if(similarMovies.length == 0) { %>
  <h1 class="text-center mt-3">No movies found for <%= searchQuery %></h1>
  <% } else { %>
  <h1 class="text-center mt-3">Search results for <%= searchQuery %></h1>

  <div class="otherThanNav">
    <div class="container">

      <div class="movie-container">
        <div class="row mb-3 text-center justify-content-center">
          <% for(let i = 0; i < similarMovies.length; i++) { %>

          <div class="card border-primary col-sm-6 col-md-4 col-lg-3 col-xl-2 mb-3">
            <img class="card-img-top mx-auto d-block m-2 rounded" src="<%= similarMovies[i].Image['280w'] %>" alt="<%= similarMovies[i].Title %>" onclick="handleClick(event, '<%= similarMovies[i].imdbID %>')">
            <div class="card-body">
              <h5 class="card-title"><%= similarMovies[i].Title %></h5>
              <div class="card-text" style="text-align: left;">
                <h6>Duration:&nbsp;<small class="text-muted"><%= similarMovies[i].Metadata[1] %></small></h6>
                <h6>Rating:&nbsp;<small class="text-muted"><%= similarMovies[i].Rating[0] %>/10</small></h6>
                <%- include('./../templates/avgRating.ejs' ,{myratings, movieTitle:similarMovies[i].Title}) %>
                <h6>Genre:&nbsp;<small class="text-muted"><%= similarMovies[i].genre.join(', ') %></small></h6>
                <h6>Director:&nbsp;<small class="text-muted"><%= similarMovies[i].Director.join(', ') %></small></h6>
                <h6>Stars:&nbsp;<small class="text-muted"><%= similarMovies[i].Cast.join(', ') %></small></h6>
              </div>
            </div>
            <div class="card-footer">
              <button type="button" class="btn btn-primary btn-sm" onclick="handleClick(event, '<%= similarMovies[i].imdbID %>')">More</button>
            </div>
          </div>
          <% } %>
        </div>
      </div>
    </div>
    <script>
      function handleClick(event, imdbID) {
        window.location.href = `/movie/${imdbID}`;
      }
    </script>


    <% } %>
    <script>
      function handleClick(event, imdbID) {
        window.location.href = `/movie/${imdbID}`;
      }
    </script>


</body>

</html>